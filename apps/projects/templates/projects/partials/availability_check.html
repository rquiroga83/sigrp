{% comment %}
Fragmento HTML para chequeo en tiempo real de disponibilidad de recursos.
RF-11: Motor de Validación de Asignaciones con HTMX.
{% endcomment %}

{% if error %}
    <div class="alert alert-danger mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    </div>
{% elif availability.error %}
    <div class="alert alert-danger mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ availability.error }}
    </div>
{% else %}
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <!-- Header con nombre del recurso -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">
                    <i class="bi bi-person-check me-2"></i>
                    <strong>{{ availability.resource_name }}</strong>
                </h6>
                <span class="badge 
                    {% if availability.status == 'available' %}bg-success
                    {% elif availability.status == 'partial' %}bg-info
                    {% elif availability.status == 'full' %}bg-warning
                    {% else %}bg-danger{% endif %}">
                    {% if availability.status == 'available' %}Disponible
                    {% elif availability.status == 'partial' %}Parcialmente Asignado
                    {% elif availability.status == 'full' %}Totalmente Asignado
                    {% else %}Sobrecargado{% endif %}
                </span>
            </div>

            <!-- Barra de Progreso -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">Utilización Semanal</small>
                    <strong class="text-{{ bar_color }}">{{ projected_utilization }}%</strong>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar {{ bar_class }} progress-bar-striped 
                        {% if projected_utilization >= 100 %}progress-bar-animated{% endif %}"
                         role="progressbar" 
                         style="width: {% if projected_utilization > 100 %}100{% else %}{{ projected_utilization }}{% endif %}%"
                         aria-valuenow="{{ projected_utilization }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ projected_utilization }}%
                    </div>
                </div>
            </div>

            <!-- Detalles de Capacidad -->
            <div class="row g-2 mb-3">
                <div class="col-4">
                    <div class="text-center p-2 bg-light rounded">
                        <small class="text-muted d-block">Capacidad</small>
                        <strong>{{ availability.capacity_weekly }}h</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="text-center p-2 bg-light rounded">
                        <small class="text-muted d-block">Asignadas</small>
                        <strong>{{ availability.total_allocated_hours }}h</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="text-center p-2 bg-light rounded">
                        <small class="text-muted d-block">Disponibles</small>
                        <strong class="{% if availability.remaining_capacity <= 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ availability.remaining_capacity }}h
                        </strong>
                    </div>
                </div>
            </div>

            <!-- Proyectos Concurrentes -->
            {% if availability.active_project_count > 0 %}
            <div class="mb-3">
                <small class="text-muted d-block mb-1">Proyectos Concurrentes ({{ availability.active_project_count }})</small>
                <div class="d-flex flex-wrap gap-1">
                    {% for project in availability.concurrent_projects %}
                    <span class="badge bg-secondary">{{ project.project__code }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- HARD BLOCK: Error de Sobrecarga -->
            {% if block_reason %}
            <div class="alert alert-danger mb-2">
                <i class="bi bi-x-circle me-2"></i>
                <strong>Asignación Bloqueada</strong>
                <p class="mb-0 mt-1 small">{{ block_reason }}</p>
            </div>
            {% endif %}

            <!-- SOFT WARNING: Alertas de Fragmentación y Alta Carga -->
            {% if warnings %}
                {% for warning in warnings %}
                <div class="alert alert-warning mb-2">
                    {{ warning }}
                </div>
                {% endfor %}
            {% endif %}

            <!-- Alerta Especial de Fragmentación -->
            {% if availability.is_fragmented %}
            <div class="alert alert-warning mb-2">
                <h6 class="alert-heading mb-1">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ⚠️ Alto Riesgo de Ineficiencia
                </h6>
                <p class="mb-0 small">
                    Este recurso está asignado a <strong>{{ availability.active_project_count }} proyectos</strong> 
                    simultáneamente. La fragmentación extrema (Context Switching) puede reducir 
                    la productividad efectiva hasta un <strong>40%</strong>.
                </p>
            </div>
            {% endif %}

            <!-- Recomendaciones -->
            {% if recommendations %}
            <div class="mt-3">
                <small class="text-muted d-block mb-2">
                    <i class="bi bi-lightbulb me-1"></i>Recomendaciones:
                </small>
                <ul class="small mb-0 ps-3">
                    {% for recommendation in recommendations %}
                    <li>{{ recommendation }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Información Adicional para Horas Solicitadas -->
            {% if requested_hours > 0 %}
            <div class="mt-3 pt-3 border-top">
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Horas Solicitadas:</small>
                    <strong>{{ requested_hours }}h/sem</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Nueva Utilización:</small>
                    <strong class="text-{{ bar_color }}">{{ projected_utilization }}%</strong>
                </div>
                {% if is_viable %}
                <div class="alert alert-success mt-2 mb-0">
                    <i class="bi bi-check-circle me-2"></i>
                    Asignación viable
                </div>
                {% else %}
                <div class="alert alert-danger mt-2 mb-0">
                    <i class="bi bi-x-circle me-2"></i>
                    Asignación no viable - Ajustar horas o cambiar recurso
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
{% endif %}
