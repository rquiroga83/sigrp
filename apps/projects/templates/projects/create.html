{% extends "base.html" %}
{% load static %}

{% block title %}Crear Proyecto - SIGRP{% endblock %}

{% block extra_css %}
<style>
    .field-group {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .field-group h5 {
        color: #495057;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    .help-text-custom {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">
                        <i class="bi bi-plus-circle me-2"></i>Crear Nuevo Proyecto
                    </h1>
                    <p class="text-muted mb-0">
                        Complete la información del proyecto. Los campos con
                        <span class="text-danger">*</span> son obligatorios.
                    </p>
                </div>
                <div>
                    <a href="{% url 'projects:list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <form method="post" id="projectForm">
                        {% csrf_token %}

                        <!-- Información Básica -->
                        <div class="field-group">
                            <h5><i class="bi bi-info-circle me-2"></i>Información Básica</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.code.id_for_label }}" class="form-label required-field">
                                            Código del Proyecto
                                        </label>
                                        {{ form.code }}
                                        {% if form.code.help_text %}
                                        <div class="help-text-custom">{{ form.code.help_text }}</div>
                                        {% endif %}
                                        {% if form.code.errors %}
                                        <div class="text-danger small mt-1">{{ form.code.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.name.id_for_label }}" class="form-label required-field">
                                            Nombre del Proyecto
                                        </label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                        <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="{{ form.description.id_for_label }}" class="form-label">
                                            Descripción
                                        </label>
                                        {{ form.description }}
                                        {% if form.description.errors %}
                                        <div class="text-danger small mt-1">{{ form.description.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.client_name.id_for_label }}" class="form-label required-field">
                                            Nombre del Cliente
                                        </label>
                                        {{ form.client_name }}
                                        {% if form.client_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.client_name.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración del Proyecto -->
                        <div class="field-group">
                            <h5><i class="bi bi-gear me-2"></i>Configuración del Proyecto</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.project_type.id_for_label }}" class="form-label required-field">
                                            Tipo de Proyecto
                                        </label>
                                        {{ form.project_type }}
                                        {% if form.project_type.help_text %}
                                        <div class="help-text-custom">{{ form.project_type.help_text }}</div>
                                        {% endif %}
                                        {% if form.project_type.errors %}
                                        <div class="text-danger small mt-1">{{ form.project_type.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label required-field">
                                            Estado
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                        <div class="text-danger small mt-1">{{ form.status.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.priority.id_for_label }}" class="form-label required-field">
                                            Prioridad
                                        </label>
                                        {{ form.priority }}
                                        {% if form.priority.errors %}
                                        <div class="text-danger small mt-1">{{ form.priority.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración Financiera - Fixed Price -->
                        <div class="field-group" id="fixedPriceFields">
                            <h5><i class="bi bi-cash-stack me-2"></i>Configuración Financiera - Fixed Price</h5>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Fixed Price:</strong> Precio fijo acordado con el cliente. El riesgo es del proveedor.
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.fixed_price.id_for_label }}" class="form-label required-field">
                                            Precio Fijo (COP)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.fixed_price }}
                                        </div>
                                        {% if form.fixed_price.help_text %}
                                        <div class="help-text-custom">{{ form.fixed_price.help_text }}</div>
                                        {% endif %}
                                        {% if form.fixed_price.errors %}
                                        <div class="text-danger small mt-1">{{ form.fixed_price.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.budget_limit.id_for_label }}" class="form-label required-field">
                                            Límite de Presupuesto (COP)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.budget_limit }}
                                        </div>
                                        {% if form.budget_limit.help_text %}
                                        <div class="help-text-custom">{{ form.budget_limit.help_text }}</div>
                                        {% endif %}
                                        {% if form.budget_limit.errors %}
                                        <div class="text-danger small mt-1">{{ form.budget_limit.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración Financiera - Time & Materials -->
                        <div class="field-group hidden" id="timeMaterialsFields">
                            <h5><i class="bi bi-clock-history me-2"></i>Configuración Financiera - Time & Materials</h5>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Time & Materials:</strong> Facturación por hora trabajada. El riesgo es del cliente.
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.hourly_rate.id_for_label }}" class="form-label">
                                            Tarifa por Hora (COP)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.hourly_rate }}
                                        </div>
                                        {% if form.hourly_rate.help_text %}
                                        <div class="help-text-custom">{{ form.hourly_rate.help_text }}</div>
                                        {% endif %}
                                        {% if form.hourly_rate.errors %}
                                        <div class="text-danger small mt-1">{{ form.hourly_rate.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.max_budget.id_for_label }}" class="form-label">
                                            Presupuesto Máximo (COP)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.max_budget }}
                                        </div>
                                        {% if form.max_budget.help_text %}
                                        <div class="help-text-custom">{{ form.max_budget.help_text }}</div>
                                        {% endif %}
                                        {% if form.max_budget.errors %}
                                        <div class="text-danger small mt-1">{{ form.max_budget.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Margen de Ganancia -->
                        <div class="field-group">
                            <h5><i class="bi bi-graph-up me-2"></i>Objetivos Financieros</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.profit_margin_target.id_for_label }}" class="form-label">
                                            Margen de Ganancia Objetivo (%)
                                        </label>
                                        {{ form.profit_margin_target }}
                                        {% if form.profit_margin_target.help_text %}
                                        <div class="help-text-custom">{{ form.profit_margin_target.help_text }}</div>
                                        {% endif %}
                                        {% if form.profit_margin_target.errors %}
                                        <div class="text-danger small mt-1">{{ form.profit_margin_target.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fechas -->
                        <div class="field-group">
                            <h5><i class="bi bi-calendar-event me-2"></i>Fechas del Proyecto</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                            Fecha de Inicio
                                        </label>
                                        {{ form.start_date }}
                                        {% if form.start_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.start_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                            Fecha de Fin Estimada
                                        </label>
                                        {{ form.end_date }}
                                        {% if form.end_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.end_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notas -->
                        <div class="field-group">
                            <h5><i class="bi bi-sticky me-2"></i>Información Adicional</h5>
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                                            Notas Internas
                                        </label>
                                        {{ form.notes }}
                                        {% if form.notes.errors %}
                                        <div class="text-danger small mt-1">{{ form.notes.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'projects:list' %}" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-lg me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-check-lg me-2"></i>Crear Proyecto
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mostrar/ocultar campos según tipo de proyecto
    document.addEventListener('DOMContentLoaded', function() {
        const projectTypeSelect = document.getElementById('id_project_type');
        const fixedPriceFields = document.getElementById('fixedPriceFields');
        const timeMaterialsFields = document.getElementById('timeMaterialsFields');

        function toggleFields() {
            const projectType = projectTypeSelect.value;

            if (projectType === 'fixed') {
                // Mostrar Fixed Price, ocultar T&M
                fixedPriceFields.classList.remove('hidden');
                timeMaterialsFields.classList.add('hidden');

                // Hacer required los campos de Fixed Price
                document.getElementById('id_fixed_price').required = true;
                document.getElementById('id_budget_limit').required = true;

                // Quitar required de T&M
                document.getElementById('id_hourly_rate').required = false;
                document.getElementById('id_max_budget').required = false;

            } else if (projectType === 't_and_m') {
                // Mostrar T&M, ocultar Fixed Price
                fixedPriceFields.classList.add('hidden');
                timeMaterialsFields.classList.remove('hidden');

                // Hacer required al menos uno de los campos T&M
                // (la validación completa se hace en el backend)
                document.getElementById('id_fixed_price').required = false;
                document.getElementById('id_budget_limit').required = false;

            } else if (projectType === 'hybrid') {
                // Mostrar ambos
                fixedPriceFields.classList.remove('hidden');
                timeMaterialsFields.classList.remove('hidden');

                // Ninguno es estrictamente required
                document.getElementById('id_fixed_price').required = false;
                document.getElementById('id_budget_limit').required = false;
                document.getElementById('id_hourly_rate').required = false;
                document.getElementById('id_max_budget').required = false;
            }
        }

        // Ejecutar al cargar y al cambiar
        projectTypeSelect.addEventListener('change', toggleFields);
        toggleFields();

        // Validación de fechas
        const startDateInput = document.getElementById('id_start_date');
        const endDateInput = document.getElementById('id_end_date');

        endDateInput.addEventListener('change', function() {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (startDate && endDate && endDate < startDate) {
                alert('La fecha de fin no puede ser anterior a la fecha de inicio');
                endDateInput.value = '';
            }
        });
    });
</script>
{% endblock %}
